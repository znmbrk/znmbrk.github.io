---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="My Runs - Projects - Zain Mobarik">

  <h1>My Runs</h1>
  <p class="author">Strava API integration project</p>

  <div style="position: relative;">
    <div id="map" style="height: 400px; width: 100%; margin: 20px 0; border: 1px solid #ccc;"></div>
    <div style="position: absolute; top: 30px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 10px;">
      <button id="locationBtn" style="background: white; border: 2px solid #333; padding: 8px 12px; cursor: pointer; font-size: 14px; border-radius: 4px;">üìç My Location</button>
      <button id="cycleBtn" style="background: white; border: 2px solid #333; padding: 8px 12px; cursor: pointer; font-size: 14px; border-radius: 4px;">üèÉ Next Run</button>
    </div>
  </div>

  <h2>Project Explanation</h2>

  <p>Utilised Strava's API to send POST and GET requests to track data about my runs. I then used JavaScript to display this data on my map.</p>

  <p>I used Postman to send my POST and GET requests. These requests were made to retrieve my personal refresh and authorisation tokens for Strava's API.</p>

  <h2>Cool Features!</h2>

  <h3>Display of the Map</h3>
  <p>In order to display the map, I used an online map called Open Street Map</p>

  <h3>Polyline Decoding</h3>
  <p>I then had to decode the coordinates of my runs as they were in a string format. Hence, I had to use a Polyline decoder to get the numeric value to then add to my map.</p>

  <hr>

  <p><a href="/projects">‚Üê Back to projects</a></p>

  <script is:inline>
    console.log('Script is running!');

    // Wait for page to load, then load Leaflet and initialize map
    window.addEventListener('load', function() {
      console.log('Page loaded, starting Leaflet setup...');

      // Load Leaflet CSS
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.8.0/dist/leaflet.css';
      document.head.appendChild(link);

      // Load Leaflet JS
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.8.0/dist/leaflet.js';
      script.onload = function() {
        console.log('Leaflet loaded successfully');
        initializeMap();
      };
      script.onerror = function() {
        console.error('Failed to load Leaflet');
        // Show a simple sample map instead
        document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; background: #f0f0f0;">Map loading failed. Please check your internet connection.</div>';
      };
      document.head.appendChild(script);
    });

    // Global variables for button functionality
    let globalMap;
    let activities = [];
    let currentRunIndex = 0;

    function initializeMap() {
      // First create a basic map to test
      console.log('Initializing map...');
      globalMap = L.map('map').setView([52.38199, -1.561976], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(globalMap);

      // Add a test marker
      L.marker([52.38199, -1.561976]).addTo(globalMap)
        .bindPopup('Loading your Strava data...')
        .openPopup();

      // Set up button event listeners
      setupButtons();

      // Now try to load Strava data
      loadStravaData(globalMap);
    }

    function setupButtons() {
      // My Location button
      document.getElementById('locationBtn').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            globalMap.setView([lat, lng], 15);

            // Add or update current location marker
            if (window.currentLocationMarker) {
              globalMap.removeLayer(window.currentLocationMarker);
            }

            window.currentLocationMarker = L.marker([lat, lng], {
              icon: L.divIcon({
                className: 'current-location-marker',
                html: '<div style="background: #4285f4; border: 3px solid white; width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
              })
            }).addTo(globalMap).bindPopup('üìç Your current location');

          }, function(error) {
            alert('Error getting your location: ' + error.message);
          });
        } else {
          alert('Geolocation is not supported by this browser.');
        }
      });

      // Cycle through runs button
      document.getElementById('cycleBtn').addEventListener('click', function() {
        if (activities.length === 0) {
          alert('No runs loaded yet!');
          return;
        }

        currentRunIndex = (currentRunIndex + 1) % activities.length;
        const currentActivity = activities[currentRunIndex];

        if (currentActivity.start_latlng) {
          globalMap.setView([currentActivity.start_latlng[0], currentActivity.start_latlng[1]], 14);

          // Find and highlight the current run
          globalMap.eachLayer(function(layer) {
            if (layer instanceof L.Polyline && layer.options.activityId === currentActivity.id) {
              layer.openPopup();
            }
          });
        }

        // Update button text to show which run we're viewing
        document.getElementById('cycleBtn').innerHTML = `üèÉ Run ${currentRunIndex + 1}/${activities.length}`;
      });
    }

    function loadStravaData(map) {
      console.log('Loading Strava data...');

      fetch("https://www.strava.com/oauth/token", {
        method: "POST",
        headers: {
          "Accept": "application/json, text/plain, */*",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          client_id: "88503",
          client_secret: "fcbcf53e9cd8bb3d0387e04b93b6a784923b901e",
          refresh_token: "e239e8706ab7995e2048a877cf10909214db6d78",
          grant_type: "refresh_token"
        })
      })
      .then(res => res.json())
      .then(tokenData => {
        console.log('Token refresh successful');
        return fetch(`https://www.strava.com/api/v3/athlete/activities?access_token=${tokenData.access_token}&per_page=10`);
      })
      .then(res => res.json())
      .then(data => {
        console.log('Activities loaded:', data.length);
        activities = data; // Store activities globally

        if (activities.length > 0) {
          // Clear the loading marker
          map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });

          const colors = ['green', 'blue', 'red', 'purple', 'orange', 'darkgreen', 'cadetblue'];
          let routeCount = 0;

          activities.forEach((activity, index) => {
            if (activity.map && activity.map.summary_polyline) {
              // Simple polyline decoding
              const coords = decodePolyline(activity.map.summary_polyline);

              L.polyline(coords, {
                color: colors[index % colors.length],
                weight: 4,
                opacity: 0.7,
                activityId: activity.id // Add activity ID for cycling
              }).addTo(map).bindPopup(`
                <b>${activity.name}</b><br>
                Distance: ${(activity.distance / 1000).toFixed(2)} km<br>
                Duration: ${Math.floor(activity.moving_time / 60)} minutes<br>
                <small>Click "Next Run" to cycle through runs</small>
              `);

              routeCount++;
            }
          });

          // Center on first activity
          if (activities[0].start_latlng) {
            map.setView([activities[0].start_latlng[0], activities[0].start_latlng[1]], 12);
          }

          // Add summary marker
          L.marker([activities[0].start_latlng[0], activities[0].start_latlng[1]]).addTo(map)
            .bindPopup(`<b>My Running Routes</b><br>${routeCount} routes displayed<br><small>Use the buttons to navigate</small>`)
            .openPopup();

          // Update cycle button with initial count
          document.getElementById('cycleBtn').innerHTML = `üèÉ Run 1/${activities.length}`;
        }
      })
      .catch(error => {
        console.error('Error loading Strava data:', error);
        L.marker([52.38199, -1.561976]).addTo(map)
          .bindPopup('Error loading Strava data. Check console for details.')
          .openPopup();
      });
    }

    // Simplified polyline decoder
    function decodePolyline(encoded) {
      var points = [];
      var index = 0, len = encoded.length;
      var lat = 0, lng = 0;

      while (index < len) {
        var b, shift = 0, result = 0;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        var dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lat += dlat;

        shift = 0;
        result = 0;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        var dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lng += dlng;

        points.push([lat * 1e-5, lng * 1e-5]);
      }
      return points;
    }
  </script>
</Layout>